<!DOCTYPE html>
<html>
<head><meta charset="utf-8" />
<title>External_task</title><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>








<!-- Custom stylesheet, it must be in the same directory as the html file -->
<link rel="stylesheet" href="custom.css">

<!-- Loading mathjax macro -->
<!-- Load mathjax -->
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
    <!-- MathJax configuration -->
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
            processEscapes: true,
            processEnvironments: true
        },
        // Center justify equations in code and markdown cells. Elsewhere
        // we use CSS to left justify single line equations in code cells.
        displayAlign: 'center',
        "HTML-CSS": {
            styles: {'.MathJax_Display': {"margin": 0}},
            linebreaks: { automatic: true }
        }
    });
    </script>
    <!-- End of mathjax configuration --></head>

 <link rel="stylesheet" href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/jquery-ui.min.js"></script>

<style>  /* defined here in case the main.css below cannot be loaded */
.lev1 {margin-left: 80px}
.lev2 {margin-left: 100px}
.lev3 {margin-left: 120px}
.lev4 {margin-left: 140px}
.lev5 {margin-left: 160px}
.lev6 {margin-left: 180px}
</style>

<link rel="stylesheet" type="text/css" href="../../css/jt.css">
<link rel="stylesheet" type="text/css" href="../../css/toc2.css">

<script src="https://rawgit.com/ipython-contrib/jupyter_contrib_nbextensions/master/src/jupyter_contrib_nbextensions/nbextensions/toc2/toc2.js"></script>

 <script src="../../js/docs.js"></script>

<script>
    MathJax.Hub.Config({
        "HTML-CSS": {
            preferredFont: "TeX",
            availableFonts: ["STIX","TeX"],
            styles: {
                scale: 110,
                ".MathJax_Display": {
                    "font-size": "110%",
                }
            }
        }
    });
</script>

<script>
$( document ).ready(function(){

            var cfg={'threshold':4,     // depth of toc (number of levels)
             // 'number_sections': true,  // sections numbering
             'number_sections': false, 
             'toc_cell': false,          // useless here
             'toc_window_display': true, // display the toc window
             "toc_section_display": "block", // display toc contents in the window
             // 'sideBar':true,      
             'sideBar':true,       // sidebar or floating window
             'navigate_menu':false       // navigation menu (only in liveNotebook -- do not change)
            }

            var st={};                  // some variables used in the script
            st.rendering_toc_cell = false;
            st.config_loaded = false;
            st.extension_initialized=false;
            st.nbcontainer_marginleft = $('#notebook-container').css('margin-left')
            st.nbcontainer_marginright = $('#notebook-container').css('margin-right')
            st.nbcontainer_width = $('#notebook-container').css('width')
            st.oldTocHeight = undefined
            st.cell_toc = undefined;
            st.toc_index=0;

            // fire the main function with these parameters



            table_of_contents(cfg,st);

            var file=documentationDict[$("h1:first").attr("id")];
            var path="http://vatlab.github.io/SOS"
            // var path="file:///Users/jma7/Development/SOS/docs"
            $("#toc-level0 a").css("color","#126dce");
            $('a[href="#'+$("h1:first").attr("id")+'"]').hide()
            var docs=documentation;
            var pos=documentation.indexOf(file);
        
            for (var a=pos;a>=0;a--){
                  var name=docs[a]
                  $('<li><a href="'+path+'/doc/documentation/'+name+'.html">'+name.replace(/_/g," ")+'</a></li>').insertBefore("#toc-level0 li:eq(0)");
            }
            $('a[href="'+path+'/doc/documentation/'+file+'.html'+'"]').css("color","#126dce");


            $('<li id="indexHome" style="margin-bottom:10pt"> <a href="http://vatlab.github.io/SOS/index.html#documentation"> <img height="32" width="32" style="border:0px;margin-right:5px;vertical-align:bottom" src="http://vatlab.github.io/SOS/img/sos_icon.svg"> <b>Home</b></a> </li>').insertBefore("#toc-level0 li:eq(0)");

            // $('<li id="indexHome"><a href="/Users/jma7/Development/SOS/docs/index.html#documentation"><b>Home<b></a></li>').insertBefore("#toc-level0 li:eq(0)");
            for (var a=pos+1;a<docs.length;a++){
                  var name=docs[a]
                  $(".toc #toc-level0").append('<li><a href="'+path+'/doc/documentation/'+name+'.html">'+name.replace(/_/g," ")+'</a></li>');
            }
            $("#toc-header").hide();

            // var path="file:///Users/jma7/Development/SOS/website"
            // $(".toc #toc-level0").append('<li id="indexHome"><a href="'+path+'/index.html" ><b>Home<b></a></li>');

            // var docs=documentation
            // for (var a =0;a<docs.length;a++){
            //       var name =docs[a];
            //       $(".toc #toc-level0").append('<li><a href="'+path+'/doc/documentation/'+name+'.html">'+name.split("_").join(" ")+'</a></li>');
            // }
            // var home=$("#toc-level0 #indexHome");
          
            // home.insertBefore("#toc-level0 li:eq(0)");
            // $("#toc-header").hide();

            // $("#toc-level0 li").filter(".home").insertBefore($("#toc-level0 li").filter(':nth-child(1)'));
            $("#toc").attr("style","max-height:938px")


    });
</script><style>  /* defined here in case the main.css below cannot be loaded */

 .lan_sos {}

</style>
<body>
  <div tabindex="-1" id="notebook" class="border-box-sizing">
    <div class="container" id="notebook-container">

<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Executing-external-tasks">Executing external tasks<a class="anchor-link" href="#Executing-external-tasks">&#182;</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A complex workflow usually have a large number of steps, most of them are light-weight and can be executed locally, but some of them can be time- and resource-consuming and would better be executed on dedicated servers or cluster systems. There are several approaches in running such workflows, namely,</p>
<ol>
<li><p>Execute the entire workflow on the cluster as a single multi-processing job. This is not ideal because 1). you would have to allocate enough resource for the most CPU and RAM-demanging step and longest execution time for the most time-consuming step but these resources are not utilized efficiently, and 2). you are limiting yourself to a single node and cannot really execute the workflow in parallel.</p>
</li>
<li><p>Separate the workflow by steps and submit them as separate tasks to a queuing system. This approach allows better parallelization but it can be difficult and time consuming to execute a large number of small jobs, because these tasks might spend more time waiting than running.</p>
</li>
<li><p>Running a workflow on a cluster system requires a running server (task dispatcher, corrdinator) to corrdinate the execution of dependent steps. This has posed a problem, at least to our clusters because such processes are not allowed on the head node.</p>
</li>
</ol>
<p>To address these problems, SoS taks a different approach than mose other workflow systems.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="SoS'-task-model">SoS' task model<a class="anchor-link" href="#SoS'-task-model">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Complete-workflow">Complete workflow<a class="anchor-link" href="#Complete-workflow">&#182;</a></h3><p>SoS defines workflows as steps to execute certain procedures on input files (forward-style), or as steps to produce desired outputs (makefile style). All steps, regardless of their sizes (requirement for resources), are written as a single workflow. That is to say, a long running sequence alignment step and the relatively quick statistical analysis steps would be defined as a single workflow. <strong>steps are not separated because of their different hardware/software requirements</strong>.</p>
<p>SoS executes all steps directly as a complete workflow. The workflow is executed in a multi-processing manner where multiple processes (by default to 4) are used to execute different branches of the DAG (Direct Acyclic Graph) in parallel.</p>
<h3 id="Generation-of-external-tasks">Generation of external tasks<a class="anchor-link" href="#Generation-of-external-tasks">&#182;</a></h3><p>Part of the steps can be defined as tasks that are executed externally. SoS tasks have the following properties:</p>
<ul>
<li><strong>Tasks are self-contained</strong> in that they contain all the required information to be executed anywhere. </li>
<li><strong>Tasks are generated and executed dynamically</strong> in that a task would only be generated when all its dependencies have been met.</li>
<li><strong>Tasks are independent of workflows and other tasks</strong>. Tasks are defined by the task they are executing. Tasks can be shared by different workflows if they happen to perform exactly the same function.</li>
<li><strong>Tasks are file system independent</strong> in the sense that sos automatically synchronize input and output of tasks to remote systems so you can easily switch from a remote server to another, or to a cluster system.</li>
</ul>
<h3 id="Remote-execution-of-tasks">Remote execution of tasks<a class="anchor-link" href="#Remote-execution-of-tasks">&#182;</a></h3><p>SoS tasks can be executed locally as separate  processes, remotely on a remote server, sent to distributed task-queues (such as <a href="http://python-rq.org/">rq</a> or <a href="http://www.celeryproject.org/">Celery</a>, or cluster systems based on PBS, Torch, or SunGrid. SoS handles file synchronization so <strong>tasks could be submitted to queues with their own file systems</strong>.</p>
<h3 id="Stop-and-resume-execution-of-workflow">Stop-and-resume execution of workflow<a class="anchor-link" href="#Stop-and-resume-execution-of-workflow">&#182;</a></h3><p>SoS can wait for the completion of the tasks as if they are just long-running jobs executed locally. Alternatively, sos could exit and wait for the completion of external tasks. Command <code>sos status</code> or task-queue-specific methods could be used to monitor the execution of tasks.</p>
<p>After the completion of the tasks, you could rerun the workflow and SoS would resume execution from the point where it was stopped.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Flexible-design-of-workflows">Flexible design of workflows<a class="anchor-link" href="#Flexible-design-of-workflows">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This external execution model offers great flexibility in the execution of workflows. For example,</p>
<ul>
<li>You can execute a step on a remote server with more resource by specifying parameter <code>queue</code> of a single task.</li>
<li>You can submit all tasks of a workflow to a cluster by specifying cluster name with the <code>-q</code> option of command <code>sos run</code>.</li>
<li>You can submit part of the tasks to one machine, and part of the tasks to another task queue using the combination of task-specific option and global <code>-q</code> option.</li>
<li>You can use SoS as a task-generation tool to generate a bunch of tasks, and send the tasks to different computer systems for execution. SoS automatically handles file synchronization so that you can easily move from one cluster to another cluster or another server.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The following figure illustrates the task model of SoS</p>
<p><img src="../media/job_queue.svg" alt="job queue"></p>
<p>Basically,</p>
<ol>
<li>Tasks are part of step processes.</li>
<li>Tasks are managed by task engines, multiple task engines can be used for a single workflow.</li>
<li>Task engines generate task files, submit tasks, monitor task status, and return results to SoS workflow.</li>
<li>Remote task engines synchronize input files, translate and copy tasks to server, and start the tasks on the remote server. Pre-defined <code>submit_cmd</code> could be used to submit tasks to batch systems such as PBS/Moab.</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Specification-of-tasks">Specification of tasks<a class="anchor-link" href="#Specification-of-tasks">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A <strong>step process</strong> consists of everything after the <code>input</code> statement. It can be repeated with different <strong>input groups</strong> defined by input options <code>group_by</code> or <code>for_each</code>. For example, if <code>bam_files</code> is a list of bam files,</p>

<pre><code>[10]
input: bam_files, group_by=1
output: "${_input}.bai"

run:
    samtools index ${_input}</code></pre>
<p>execute a shell script to process each bam file. This is done sequentially for each input file, and is performed by SoS.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You can easily specify part of the step process as <strong>tasks</strong>, by prepending the statements with a <code>task</code> keyword:</p>

<pre><code>[10]
input: bam_files, group_by=1
output: "${_input}.bai"

task:
run:
    samtools index ${_input}</code></pre>
<p>This statement declares the rest of the step process as a <code>task</code>. For each input file, a task will be created with an ID determined from task content and context (input and output files, variables etc). The task will be by default executed by a <code>process</code> task queue where tasks are started as background processes.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The benefit of executing tasks externally is that you can execute tasks concurrently, on the local machine or a remote server, or be submitted to a task queue. For example, using</p>

<pre><code>[10]
input: bam_files, group_by=1
output: "${_input}.bai"

task: concurrent=True
run:
    samtools index ${_input}</code></pre>
<p>Multiple tasks could be executed in parallel (but on the same machine), and you can use command</p>

<pre><code>sos run myscript -q cluster</code></pre>
<p>or use option <code>queue</code></p>

<pre><code>[10]
input: bam_files, group_by=1
output: "${_input}.bai"

task: concurrent=True, queue='cluster'
run:
    samtools index ${_input}</code></pre>
<p>to submit the commands to a cluster system to be executed on different computing nodes.</p>
<p>This document focuses on the configuration of servers and the use of task options to execute tasks on different types of servers or task queues. It provides a comprehensive list of options while the <a href="../tutorials/Remote_Execution.html">Remote Execution tutorial</a> gives a more step-by-step tutorial on how to configure and use the remote execution features.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Common-host-configuration">Common host configuration<a class="anchor-link" href="#Common-host-configuration">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A server or task queue needs to be defined in SoS configuration file. SoS automatically loads a global configuration file <code>~/.sos/config.yml</code>, and a local configuration file <code>./config.yml</code>. You can also put your settings in any configuration file and specify it with option <code>-c</code>. We recommend that you define all host configuration in global configuration file <code>~/.sos/config.yml</code> so that it can be used by all your projects.</p>
<p>The configuration file could be edited manually if you are familiar with the YAML format. Otherwise you can use the <code>sos config</code> command to add or modify settings. For example, command</p>
<div class="highlight"><pre><span></span>sos config --global --set hosts.shark.address username@shark.com
</pre></div>
<p>would write to <code>~/.sos/config.yml</code> the following content</p>

<pre><code>yml
hosts:
    shark:
        address: username@shark.com</code></pre>
<p>This effectively defines a host with alias <code>shark</code>. All configurations related to this host should be defined under <code>shark</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="address"><code>address</code><a class="anchor-link" href="#address">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>IP address or URL to the remote host. Name <code>localhost</code> can be used for localhost. If you have a different user name on the the remote host, specify the <code>address</code> in the format of <code>username@hostaddress</code>.</p>
<p>Note that SoS does not support username/password authentication and you will have to set up public key authentication between local and remote hosts to  communicate with remote host.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="path_map"><code>path_map</code><a class="anchor-link" href="#path_map">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>path_map</code> is a list of directory mappings between local and remote directories. Paths in a <code>path_map</code> should be absolute path and a local path will be converted to absolute path before mapping. For example, a <code>path_map</code></p>

<pre><code>/Users/myuser/:/home/myuser/</code></pre>
<p>would map <code>test/a.txt</code> under home directory to <code>/home/myuser/test/a.txt</code>, and map <code>/Users/myuser/resources</code> to <code>/home/myuser/resources</code>.</p>
<p>Multiple <code>path_map</code> could be defined and a path is mapped by the first matching <code>path_map</code>. For example,</p>

<pre><code>/Users/myuser/projects/:/home/myuser/scratch/projects/
/Users/myuser:/home/myuser</code></pre>
<p>will map <code>/Users/myuser/projects/input.fastq</code> to <code>/home/myuser/scratch/projects/input.fastq</code>, and <code>/users/myuser/a.txt</code> to <code>/home/myuser/a.txt</code>.</p>
<p>The order of the map is significant and the second <code>path_map</code> in the following configuration will be ignored because it is shadowed by the first one.</p>

<pre><code>/Users/myuser:/home/myuser
/Users/myuser/projects/:/home/myuser/scratch/projects/</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="shared"><code>shared</code><a class="anchor-link" href="#shared">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Option <code>shared</code> tells SoS which file systems are shared between local and remote hosts so that it does not have to synchronize files under these directories between the hosts.</p>
<p>You will need to</p>
<ul>
<li>Ignore this option if the local and remote hosts does not share any file system.</li>
<li>set <code>shared</code> to <code>/</code> (root) if your local and remote host share all file systems</li>
<li>List volumes that are shared between your local and remote systems</li>
</ul>
<p>Shared file systems do not have to be mounted at the same locations. For example, a local file system <code>/projects</code> might be available at the remote host under <code>/scratch/projects</code>. In this case, you should</p>
<ul>
<li>Set <code>/projects</code> as <code>shared</code> so that files under <code>/projects</code> will not be copied.</li>
<li>Set <code>/projects:/scratch/projects</code> in <code>path_map</code> so that the path can be correctly translated between local and remote hosts.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="send_cmd"><code>send_cmd</code><a class="anchor-link" href="#send_cmd">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>SoS uses <code>rsync</code> command to exchange files between hosts, and use <code>ssh</code> to execute command. If the default commands do not work for your configuration (e.g. if you do not have <code>rsync</code> and need to use <code>scp</code>, you can define options <code>send_cmd</code> (and <code>received_cmd</code> and <code>execute_cmd</code>) for your particular configuration. These variables should be defined with <code>${source}</code> and <code>${dest}</code> which will be replaced by source and destination filenames for each file.</p>
<p>It is rather tricky to define <code>send_cmd</code> for all scenarios (files, directories, missing directory on remote host) so it is usually easier to install <code>rsync</code> and use system default <code>send_cmd</code> than defining <code>send_cmd</code> by youself.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="receive_cmd"><code>receive_cmd</code><a class="anchor-link" href="#receive_cmd">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Command to receive files from remote server. It is usually easier to install <code>rsync</code> than defining this option.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="execute_cmd"><code>execute_cmd</code><a class="anchor-link" href="#execute_cmd">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Command to execute a command on remote host. The default value should work in almost all cases.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Common-queue-configuration">Common queue configuration<a class="anchor-link" href="#Common-queue-configuration">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="queue_type"><code>queue_type</code><a class="anchor-link" href="#queue_type">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Option <code>query_type</code> determines the type of remote server or job queue. SoS currently supports the following types of job queues:</p>
<ol>
<li><strong><code>process</code></strong>: this is the default queue type. Tasks are executed directly, either on local host or on a server.</li>
<li><strong><code>pbs</code></strong>: A PBS/MOAB cluster system where tasks are submitted using commands such as <code>qsub</code>.</li>
<li><strong><code>rq</code></strong>: A redis queue where tasks are submitted to the rq server and monitored through rq-dashboard.</li>
<li><strong><code>celery</code></strong>: A celery queue where tasks are submitted to the celery server and monitored through celery's flower module</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="status_check_interval"><code>status_check_interval</code><a class="anchor-link" href="#status_check_interval">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Option <code>status_check_interval</code> determines frequency at which SoS checks status of jobs. This is set by default to 2 seconds for <code>process</code> queue type, and <code>10</code> seconds for all other types. This number should be set to at least <code>60</code> for remote servers and longer jobs because it can be a burden to query the status of jobs very frequently.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="max_running_jobs"><code>max_running_jobs</code><a class="anchor-link" href="#max_running_jobs">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Maximum number of running jobs. This setting controls how SoS releases tasks to job queues and is independent of possible maximum running job settings of individual task queues.</p>
<p>This option is set to 10 by default.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Arbitrary-key-value-pairs">Arbitrary key value pairs<a class="anchor-link" href="#Arbitrary-key-value-pairs">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You can define arbitrary key value pairs in the host configuration. These variables could be used for the interpolation of commands and templates. For example, if you define</p>

<pre><code>yml
queue: long</code></pre>
<p>You could use</p>
<div class="highlight"><pre><span></span><span class="c1">#PBS -q ${queue}</span>
</pre></div>
<p>in your PBS job templates (configuration <code>template_file</code> or <code>job_template</code>).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="RQ-configuration">RQ configuration<a class="anchor-link" href="#RQ-configuration">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="redis_host"><code>redis_host</code><a class="anchor-link" href="#redis_host">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Address of the redis server, default to <code>localhost</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="redis_port"><code>redis_port</code><a class="anchor-link" href="#redis_port">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Port of the redis server, default to <code>6379</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Celery-configuration">Celery configuration<a class="anchor-link" href="#Celery-configuration">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="broker"><code>broker</code><a class="anchor-link" href="#broker">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>broker</code> configuration of celery app.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="backend"><code>backend</code><a class="anchor-link" href="#backend">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>backend</code> configuration of the celery app.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="PBS/Torch-configuration">PBS/Torch configuration<a class="anchor-link" href="#PBS/Torch-configuration">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="template_file"><code>template_file</code><a class="anchor-link" href="#template_file">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>template_file</code> should point to the location of a template file (available locally, not on remote host) that will be used to generate a shell script that will be submitted to the PBS system. A typical template would look like</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#PBS -N ${task}</span>
<span class="c1">#PBS -l nodes=${nodes}:ppn=${ppn}</span>
<span class="c1">#PBS -l walltime=${walltime}</span>
<span class="c1">#PBS -l mem=${mem}</span>
<span class="c1">#PBS -o ${cur_dir}/${task}.out</span>
<span class="c1">#PBS -e ${cur_dir}/${task}.err</span>
<span class="c1">#PBS -q long</span>
<span class="c1">#PBS -m ae</span>
<span class="c1">#PBS -M your@email.address</span>
<span class="c1">#PBS -v ${cur_dir}</span>

<span class="nb">cd</span> <span class="si">${</span><span class="nv">cur_dir</span><span class="si">}</span>

sos execute <span class="si">${</span><span class="nv">task</span><span class="si">}</span> -v <span class="si">${</span><span class="nv">verbosity</span><span class="si">}</span> -s <span class="si">${</span><span class="nv">sig_mode</span><span class="si">}</span> <span class="si">${</span><span class="s1">&#39;--dryrun&#39;</span><span class="p"> if run_mode == </span><span class="s1">&#39;dryrun&#39;</span><span class="p"> else </span><span class="s1">&#39;&#39;</span><span class="si">}</span>
</pre></div>
<p>The template file will be interpolated with the following information</p>
<ul>
<li><code>task</code>: task id</li>
<li><code>nodes</code>, <code>ppn</code>, <code>walltime</code>, <code>mem</code>: resource task options</li>
<li><code>cur_dir</code>:  current project directory, which will be translated to path in remote host if the task is executed remotely</li>
<li><code>verbosity</code> and <code>sig_mode</code>: sos run mode.</li>
<li><code>run_mode</code> to allow the script to be executed in dryrun mode, in which mode scripts would be printed instead of executed. It is very important to set this option because the job script would be executed directly (on head node) instead of sent to the PBS queue if sos is running in dryrun mode (<code>sos run -q pbs -n</code>).</li>
<li>Other key/value pairs you defined for the server</li>
</ul>
<p>Note that</p>
<ol>
<li>You will need to specify resource options (<code>nodes</code>, <code>ppn</code>, <code>walltime</code>, and <code>mem</code>) as task options if they are used in the template file.</li>
<li>If you need to specify more options (e.g. queue name), you will have to define multiple host entries with different options. For example, you could define two queue entries as <code>cluster-short</code> and <code>cluster-long</code> for two queues on the same cluster. These two entries could share the same template file but different <code>queue: name</code> values.</li>
<li>An often forgotten feature is that SoS string interpolation accepts arbitrary Python expressions so it is possible to specify <code>queue</code> by <code>walltime</code>, using expressions such as </li>
</ol>

<pre><code>${'long' if walltime &gt; 60*60*24*5 else 'short'}</code></pre>
<p>Note that walltime would be an integer internally even if it is specified in the format of <code>HH:MM:SS</code> in the script.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="job_template"><code>job_template</code><a class="anchor-link" href="#job_template">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>job_template</code> should be the content of the template file if you prefer listing the content directly in the config file, and happen to know how to specify multi-line strings in YAML format.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="submit_cmd"><code>submit_cmd</code><a class="anchor-link" href="#submit_cmd">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A <code>submit_cmd</code> template is the command that will be executed to submit the job. It accepts the same set of variables as <code>job_template</code>, with an additional variable <code>job_file</code> pointing to the location of the job file on the remote host. The <code>submit_cmd</code> is usually as simple as</p>
<div class="highlight"><pre><span></span>qsub <span class="si">${</span><span class="nv">job_file</span><span class="si">}</span>
</pre></div>
<p>but you could specify some options from command line instead of the job file and define <code>submit_cmd</code> as</p>
<div class="highlight"><pre><span></span>msub -l <span class="si">${</span><span class="nv">walltime</span><span class="si">}</span> &lt; <span class="si">${</span><span class="nv">job_file</span><span class="si">}</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="status_cmd"><code>status_cmd</code><a class="anchor-link" href="#status_cmd">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>An command to query the status of a submitted task. For a standard PBS system, this option could be</p>

<pre><code>qstat ${job_id}</code></pre>
<p>where <code>job_id</code> is the output of command <code>submit_cmd</code>. The <code>status_cmd</code> is interpolated with variables <code>job_id</code> (PBS job ID), <code>task</code> (SoS task id), and <code>verbosity</code> (command line verbosity level) so you would adjust options for different verbosity level (e.g. <code>${'-f' if verbosity &gt; 2 else ''}</code>).</p>
<p>Note that the <code>status_cmd</code> is only called with <code>-v 2</code> or higher.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="kill_cmd"><code>kill_cmd</code><a class="anchor-link" href="#kill_cmd">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A command to kill a submitted job on the cluster. For a standard PBS system, this option could be</p>

<pre><code>qdel ${job_id}</code></pre>
<p>where <code>job_id</code> is the output of command <code>submit_cmd</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Resource-options">Resource options<a class="anchor-link" href="#Resource-options">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The resource options will be sent to individual task queues in appropriate format. You do not have to specify all options because task queues can support a subset of these options and some task queues provide default values (and some do not). It is however generally a good idea to specify them all so that your tasks could be executed on all types of task queues.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Option-walltime">Option <code>walltime</code><a class="anchor-link" href="#Option-walltime">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Estimated maximum running time of the task. This parameter will be sent to different task queues and it is up to the task queue to decide if the task would be killed if the task could not be completed within specified <code>walltime</code>. <code>walltime</code> could be specified</p>
<ol>
<li>As an integer number (in seconds).</li>
<li>As a string in the format of <code>HH:MM:SS</code> where <code>HH</code>, <code>MM</code> and <code>SS</code> are hours, minutes, and seconds. For example, you could use <code>walltime=240:00:00</code> for a job that would run 10 days.</li>
</ol>
<p>SoS automatically converts this option to an integer and formats it appropriately for different task engines.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Option-nodes">Option <code>nodes</code><a class="anchor-link" href="#Option-nodes">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Number of computing nodes requested.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Option-ppn">Option <code>ppn</code><a class="anchor-link" href="#Option-ppn">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Number of processes on each computing node.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Option-mem">Option <code>mem</code><a class="anchor-link" href="#Option-mem">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The total amount of memory needed across all nodes. Default units are bytes; can also be expressed in megabytes (<code>mem=4000MB</code>). gigabytes (<code>mem=4GB</code>) or gibibytes (<code>mem=4GiB</code>), although all inputs would be converted to bytes internally.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Execution-options">Execution options<a class="anchor-link" href="#Execution-options">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Option-queue">Option <code>queue</code><a class="anchor-link" href="#Option-queue">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Option <code>queue</code> specifies a task queue to which the current task will be submitted. This option overrides system default (command line option <code>-q</code>) so it is generally a good idea to use command line option <code>-q</code> so that the task could be submitted to different task queues, unless the task has to be executed in a particular server (e.g. with a software that is unavailable elsewhere).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Option-preserved_vars">Option <code>preserved_vars</code><a class="anchor-link" href="#Option-preserved_vars">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>All variables in the task context environment, including implicit SoS variables such as <code>_input</code> and <code>_output</code> are automatically translated if they are string or sequence of strings (list, tuple etc). This would however translate variables such as <code>sample_name</code> with value <code>my_sample</code> to something like <code>/home/myuser/project/my_sample</code>. It is therefore important for you to identify all variables that should be preserved during context-switching in the option <code>preserved_vars</code>.</p>
<p>This variables takes a list of variable names, but a string can be specified if there is only one name. That is to say, both</p>

<pre><code>preserved_vars='sample_name'</code></pre>
<p>or</p>

<pre><code>preserved_vars=['sample_name', 'title']</code></pre>
<p>are acceptable.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Option-workdir">Option <code>workdir</code><a class="anchor-link" href="#Option-workdir">&#182;</a></h3><p>Default to current working directory.</p>
<p>Option <code>workdir</code> controls the working directory of the task. For example, the following step downloads a file to the <code>resource_dir</code> using command <code>wget</code>.</p>
<div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>

<span class="kn">task:</span> <span class="n">workdir</span><span class="o">=</span><span class="n">resource_dir</span>

<span class="kn">run:</span>
  <span class="n">wget</span> <span class="n">a_url</span> <span class="o">-</span><span class="n">O</span> <span class="n">filename</span>
</pre></div>
<p>Runtime option <code>workdir</code> will be translated to remote host if the task is executed remotely.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Option-concurrent">Option <code>concurrent</code><a class="anchor-link" href="#Option-concurrent">&#182;</a></h3><p>Default to <code>False</code>.</p>
<p>If the step process is repeated for multiple input groups (using input options <code>group_by</code> or <code>for_each</code>), the loop process can be execute in parallel by setting <code>concurrent=True</code>. The number of concurrent tasks is controlled by the <code>max_running_jobs</code> option of the task queue.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Option-env">Option <code>env</code><a class="anchor-link" href="#Option-env">&#182;</a></h3><p>The <code>env</code> option allow you to modify runtime environment, similar to the <code>env</code> parameter of the <code>subprocess.Popen</code> function. For example, you can execute your command with in a specific directory using</p>
<div class="highlight"><pre><span></span><span class="kn">task:</span>  <span class="kp">env</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;PATH&#39;</span><span class="p">:</span> <span class="s1">&#39;/path/to/mycommand&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH&#39;</span><span class="p">]}</span>
<span class="kn">run:</span>
   <span class="n">mycommand</span>
</pre></div>
<p>Option <code>env</code> is NOT translated to remote host because it is of type directionay. The job template is usually a good place to set host-specific environment.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Option-prepend_path">Option <code>prepend_path</code><a class="anchor-link" href="#Option-prepend_path">&#182;</a></h3><p>Option <code>prepend_path</code> is a shortcut to option <code>env</code> to prepend one (a string) or more (a list of strings) paths to system path. For example, the above example can be shortened to</p>
<div class="highlight"><pre><span></span><span class="kn">task:</span>  <span class="kp">prepend_path</span><span class="o">=</span><span class="s1">&#39;/path/to/mycommand&#39;</span>
<span class="kn">run:</span>
   <span class="n">mycommand</span>
</pre></div>
<p>Option <code>prepend_path</code> is NOT translated to remote host because it is likely to be host specific.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Option-active">Option <code>active</code><a class="anchor-link" href="#Option-active">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Option <code>active</code> specifies the active task within a input loop. It should be an index or a list of indexes when the task will be executed. Negative index is acceptable (e.g. task for only the last input loop will be executed with <code>active=-1</code>).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Commands-and-Options">Commands and Options<a class="anchor-link" href="#Commands-and-Options">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="sos-run--q"><code>sos run -q</code><a class="anchor-link" href="#sos-run--q">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <code>-q</code> option of command <code>sos run</code> (or <code>sos-runner</code>) sets the default task queue for all tasks. For example,</p>
<div class="highlight"><pre><span></span>sos run myscript -q shark
</pre></div>
<p>would send all tasks in workflow <code>default</code> defined in <code>myscript.sos</code> to a task queue <code>shark</code>, with detailed information about <code>shark</code> defined in either global <code>~/.sos/config.yml</code> or local (<code>./config.yml</code>) formats. You can also save configurations to other configuration files and specify them using option <code>-c</code>. E.g.</p>
<div class="highlight"><pre><span></span>sos run myscript -q shark -c shark.yml
</pre></div>
<p>Note that this option does not override option <code>queue</code> of steps so you could send some tasks to specific queues and all others to the default queue.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="dryrun-mode"><code>dryrun</code> mode<a class="anchor-link" href="#dryrun-mode">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The dryrun running mode is very useful in checking if your scripts are correctly translated and if your machine settings are correct. <strong>It is strongly recommended that you execute your script in dryrun mode before submitting them to remote hosts and/or task queues</strong>.</p>
<p>How tasks are executed depends a bit on your configuration but basically,</p>
<ol>
<li><p>For local tasks (<code>process</code> task engine), the tasks are executed directly with <code>sos execute task -n</code> (<code>-n</code> for dryrun mode).</p>
</li>
<li><p>For direct remote execution (e.g. <code>sos run script -q server -n</code> with <code>queue_type</code> set to <code>process</code> (default)), the tasks will be generated and copied to the remote server, and will be executed with command <code>sos execute task -n</code>.</p>
</li>
<li><p>For submitting to a PBS task queue (e.g. <code>sos run script -q pbs -n</code> with <code>queue_type</code> set to <code>pbs</code>), the tasks will be generated, copied to remote host. Job files will also be generated according to <code>template_file</code> or <code>job_template</code> and will be copied to the remote host. However, instead of using <code>submit_cmd</code> to submit the job to the PBS queue, <strong>the job script will be executed directly on the head node</strong>. It is therefore important for you to allow the jobs to be run in <code>dryrun</code> mode and complete in seconds. Otherwise your system admin would hunt you for running large jobs directly on head nodes.</p>
</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="sos-status"><code>sos status</code><a class="anchor-link" href="#sos-status">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Command</p>
<div class="highlight"><pre><span></span>sos status <span class="o">[</span>tasks<span class="o">]</span> -q query
</pre></div>
<p>checkes the status of tasks. You can specify any number of first characeters of a task to specify a task, for example,</p>
<div class="highlight"><pre><span></span>sos task <span class="m">7</span>
sos task 77e
sos task 7736e
</pre></div>
<p>would all work for a task with ID <code>77e36e7404cf6c2ef7079a09e84a4d6d</code>, but multiple tasks could be identifies if they share the same leading digits. Actually,</p>

<pre><code>sos task</code></pre>
<p>would match all tasks and list the status of all local tasks.</p>
<p>Option <code>-q</code> specifies the task queue to monitor. It will login to a remote host if the tasks are executed on a remote server. For example,</p>

<pre><code>sos status -q docker</code></pre>
<p>would check the status of all tasks on a remote host <code>docker</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="sos-status--v--q"><code>sos status -v -q</code><a class="anchor-link" href="#sos-status--v--q">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Option <code>-v</code> controls the details of the output of command <code>sos status</code>. For example,</p>

<pre><code>sos status e7404cf6c2 -v0</code></pre>
<p>would print just the status of the task (e.g. <code>running</code>).</p>

<pre><code>sos task 77e -v1</code></pre>
<p>would print the task id and their status</p>

<pre><code>77e36e7404cf6c2ef7079a09e84a4d6d    running
77e3c2ef7079a236e7404cf6c2f343d3    completed</code></pre>
<p>Option <code>-v0</code> and <code>-v1</code> could check the status of multiple tasks, as realized by SoS. Some tasks queues have their own task status command and option <code>-v2</code> (and upper) will use these commands (if specified) to check the status of the jobs. That is to say</p>
<div class="highlight"><pre><span></span>sos task 77e36 -v2
</pre></div>
<p>might return output of a command</p>

<pre><code>qstat 18433</code></pre>
<p>if the task has been submitted to a cluster named <code>shark</code> with a job id <code>18433</code>.</p>
<p>If you would like to know more about the tasks,</p>
<div class="highlight"><pre><span></span>sos task 77e36 -v3
</pre></div>
<p>would list the script the task is running and all variables in abbreviated format, and</p>
<div class="highlight"><pre><span></span>sos task 77e36 -v4
</pre></div>
<p>would list all variables in complete form.</p>
<p>Finally, using <code>-q</code> in combination with <code>-v</code> allows you to list the variables used in remote server.</p>
<div class="highlight"><pre><span></span>sos task 77e36 -v4 -q linux
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="sos-kill"><code>sos kill</code><a class="anchor-link" href="#sos-kill">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Command</p>
<div class="highlight"><pre><span></span>sos <span class="nb">kill</span> <span class="o">[</span>tasks<span class="o">]</span> <span class="o">[</span>-q queue<span class="o">]</span>
</pre></div>
<p>kills specified or all tasks on specified job queue <code>queue</code>. Because the same job could be executed on different queues (you have have done so), you will have to specify the correct queue name to kill the job on different queues.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="sos-execute"><code>sos execute</code><a class="anchor-link" href="#sos-execute">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Command</p>

<pre><code>`
sos execute [tasks] [-q queue]</code></pre>
<p>is the command that is used internally by <code>sos run</code> to execute tasks but you could use this command to execute tasks externally. For example, if a task failed on a server, you could use command</p>

<pre><code>sos execute task_id -q server</code></pre>
<p>to execute the command on another server. Note that <code>task_id</code> specifies a local task with local paths. The task will be converted to a remote task (with path names converted for that host) if <code>server</code> specifies a remote host. This makes it easy for you to re-submit tasks to the same server after changing server configuration, or submit the same task to a different server.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Examples">Examples<a class="anchor-link" href="#Examples">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Remote-execution">Remote execution<a class="anchor-link" href="#Remote-execution">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="PBS-Cluster">PBS Cluster<a class="anchor-link" href="#PBS-Cluster">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Host-configuration">Host configuration<a class="anchor-link" href="#Host-configuration">&#182;</a></h4><p><code>~/.sos/config.yml</code></p>

<pre><code>yml
hosts:
  nautilus:
    address: mdarisngc03.mdanderson.edu
    path_map:
    - /Users/bpeng1:/scratch/bcb/bpeng1
    queue_type: pbs
    status_check_interval: 30
    template_file: ~/.sos/HPC.tmpl
    max_running_jobs: 100
    submit_cmd: msub ${job_file}
    status_cmd: qstat ${job_id}
    kill_cmd: qdel ${job_id}</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Job-template">Job template<a class="anchor-link" href="#Job-template">&#182;</a></h4><p><code>~/.sos/HPC.tmpl:</code></p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#PBS -N ${task}</span>
<span class="c1">#PBS -l nodes=${nodes}:ppn=${ppn}</span>
<span class="c1">#PBS -l walltime=${walltime}</span>
<span class="c1">#PBS -l mem=${mem}</span>
<span class="c1">#PBS -o ${cur_dir}/${task}.out</span>
<span class="c1">#PBS -e ${cur_dir}/${task}.err</span>
<span class="c1">#PBS -m ae</span>
<span class="c1">#PBS -M bpeng@mdanderson.org</span>
<span class="c1">#PBS -v ${cur_dir}</span>

<span class="nb">cd</span> <span class="si">${</span><span class="nv">cur_dir</span><span class="si">}</span>

sos execute <span class="si">${</span><span class="nv">task</span><span class="si">}</span> -v <span class="si">${</span><span class="nv">verbosity</span><span class="si">}</span> -s <span class="si">${</span><span class="nv">sig_mode</span><span class="si">}</span> <span class="si">${</span><span class="s1">&#39;--dryrun&#39;</span><span class="p"> if run_mode==</span><span class="s1">&#39;dryrun&#39;</span><span class="p"> else </span><span class="s1">&#39;&#39;</span><span class="si">}</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Test-script">Test script<a class="anchor-link" href="#Test-script">&#182;</a></h4>
<pre><code>[10]
input: for_each={'tid': range(10) }

task: concurrent=True, walltime='00:20:00', mem='100M', nodes=1, ppn=1

run:
    echo I am task ${tid}
    sleep ${60  * (tid + 1)}</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Commands">Commands<a class="anchor-link" href="#Commands">&#182;</a></h4>
<pre><code>sos run test -q nautilus
sos status -q nautilus
sos kill cb1 -q nautilus</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It can be tricky to get everything working but you only need to do this once for each server or task queue that you would like to use. After that, you are free to submit your tasks to any of the servers without worrying about different file systems, task queues etc.</p>

</div>
</div>
</div>
    </div>
  </div>
</body>

 


</html>
