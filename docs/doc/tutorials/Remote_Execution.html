<!DOCTYPE html>
<html>
<head><meta charset="utf-8" />
<title>Remote_Execution</title><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>








<!-- Custom stylesheet, it must be in the same directory as the html file -->
<link rel="stylesheet" href="custom.css">

<!-- Loading mathjax macro -->
<!-- Load mathjax -->
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
    <!-- MathJax configuration -->
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
            processEscapes: true,
            processEnvironments: true
        },
        // Center justify equations in code and markdown cells. Elsewhere
        // we use CSS to left justify single line equations in code cells.
        displayAlign: 'center',
        "HTML-CSS": {
            styles: {'.MathJax_Display': {"margin": 0}},
            linebreaks: { automatic: true }
        }
    });
    </script>
    <!-- End of mathjax configuration --></head>

 <link rel="stylesheet" href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/jquery-ui.min.js"></script>

<style>  /* defined here in case the main.css below cannot be loaded */
.lev1 {margin-left: 80px}
.lev2 {margin-left: 100px}
.lev3 {margin-left: 120px}
.lev4 {margin-left: 140px}
.lev5 {margin-left: 160px}
.lev6 {margin-left: 180px}
</style>

<link rel="stylesheet" type="text/css" href="../../css/jt.css">
<link rel="stylesheet" type="text/css" href="../../css/toc2.css">

<script src="https://rawgit.com/ipython-contrib/jupyter_contrib_nbextensions/master/src/jupyter_contrib_nbextensions/nbextensions/toc2/toc2.js"></script>

 <script src="../../js/docs.js"></script>

<script>
    MathJax.Hub.Config({
        "HTML-CSS": {
            preferredFont: "TeX",
            availableFonts: ["STIX","TeX"],
            styles: {
                scale: 110,
                ".MathJax_Display": {
                    "font-size": "110%",
                }
            }
        }
    });
</script>

<script>
$( document ).ready(function(){

            var cfg={'threshold':4,     // depth of toc (number of levels)
             // 'number_sections': true,  
             'number_sections': false,  // sections numbering
             'toc_cell': false,          // useless here
             'toc_window_display': true, // display the toc window
             "toc_section_display": "block", // display toc contents in the window
             // 'sideBar':true,      
             'sideBar':true,       // sidebar or floating window
             'navigate_menu':false       // navigation menu (only in liveNotebook -- do not change)
            }

            var st={};                  // some variables used in the script
            st.rendering_toc_cell = false;
            st.config_loaded = false;
            st.extension_initialized=false;
            st.nbcontainer_marginleft = $('#notebook-container').css('margin-left')
            st.nbcontainer_marginright = $('#notebook-container').css('margin-right')
            st.nbcontainer_width = $('#notebook-container').css('width')
            st.oldTocHeight = undefined
            st.cell_toc = undefined;
            st.toc_index=0;

            // fire the main function with these parameters


            table_of_contents(cfg,st);


            var file=tutorialsDict[$("h1:first").attr("id")];
            var path="http://vatlab.github.io/SOS"
            // var path="file:///Users/jma7/Development/SOS/docs"
            $("#toc-level0 a").css("color","#126dce");
            $('a[href="#'+$("h1:first").attr("id")+'"]').hide()
            
            var tuts=tutorials;
            var pos=tutorials.indexOf(file);
        
            for (var a=pos;a>=0;a--){
                  var name=tuts[a]
                  $('<li><a href="'+path+'/doc/tutorials/'+name+'.html">'+name.replace(/_/g," ")+'</a></li>').insertBefore("#toc-level0 li:eq(0)");
            }
            $('a[href="'+path+'/doc/tutorials/'+file+'.html'+'"]').css("color","#126dce");

            $('<li id="indexHome" style="margin-bottom:10pt"> <a href="http://vatlab.github.io/SOS/index.html#documentation"> <img height="32" width="32" style="border:0px;margin-right:5px;vertical-align:bottom" src="http://vatlab.github.io/SOS/img/sos_icon.svg"> <b>Home</b></a> </li>').insertBefore("#toc-level0 li:eq(0)");
            for (var a=pos+1;a<tuts.length;a++){
                  var name=tuts[a]
                  $(".toc #toc-level0").append('<li><a href="'+path+'/doc/tutorials/'+name+'.html">'+name.replace(/_/g," ")+'</a></li>');
            }
            $("#toc-header").hide();
            $("#toc").attr("style","max-height:938px")


            // for (var a =0;a<tuts.length;a++){
            //       var name =tuts[a];
            //       if ()
            //       $(".toc #toc-level0").append('<li><a href="'+path+'/doc/tutorials/'+name+'.html">'+name.replace("_"," ")+'</a></li>');
            // }

            // $(".toc #toc-level0").append('<li id="indexHome"><a href="'+path+'/index.html"><b>Home<b></a></li>');
            // var home=$("#toc-level0 #indexHome");
          
            // home.insertBefore("#toc-level0 li:eq(0)");

            
            // $(".number_sections-btn").hide();
            // $(".toc_cell_sections-btn".hide();


    });
</script><style>  /* defined here in case the main.css below cannot be loaded */

 .lan_sos {}.lan_python2 {background-color: #F6FAEA !important }.lan_python3 {background-color: #EAFAF1 !important }.lan_ir {background-color: #FDEDEC !important }.lan_bash {background-color: #E6EEFF !important }

</style>
<body>
  <div tabindex="-1" id="notebook" class="border-box-sizing">
    <div class="container" id="notebook-container">

<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Execution-of-tasks-on-remote-hosts">Execution of tasks on remote hosts<a class="anchor-link" href="#Execution-of-tasks-on-remote-hosts">&#182;</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>SoS allows you to execute tasks on remote hosts or task queues with or without their own file systems. For example, you can execute a complex workflow mostly locally, but execute a few tasks on a remote host if it provides more computing power, or if it has some software that cannot be installed locally. The remote host could have its own file system (separate systems), share its file system with the local machine (e.g. nodes on the cluster), or share some storage with the local machine (e.g. have the same shared storage), so file synchronization will be needed in some cases.</p>
<p>With help from a few runtime options (options to <code>task</code>), SoS can</p>
<ul>
<li>Copy specified local files to the remote host, possibly to different directories</li>
<li>Start a SoS task on the remote machine or submit the tak to a task queue (e.g. PBS or Celery) and wait for the completion of the task</li>
<li>Copy results back from the remote host if the execution is successful</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="System-setup">System setup<a class="anchor-link" href="#System-setup">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Public-key-access">Public-key access<a class="anchor-link" href="#Public-key-access">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Following any online tutorial, set up public-key access from your local machine to the remote host. If your public key does not work, check file permissions of <code>~/.ssh</code>, files under <code>.ssh</code>, and <code>$HOME</code> in some cases. After setting up the server, make sure you can login without password using command</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<div class="highlight"><pre><span></span>% ssh remote-host
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Software-installation">Software installation<a class="anchor-link" href="#Software-installation">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You will need to install the latest version of sos (preferrably identical version between local and remote hosts), and the software you will need to run. Test it by logging to the remote machine with commands</p>
<div class="highlight"><pre><span></span>% sos -h
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Check-$PATH">Check <code>$PATH</code><a class="anchor-link" href="#Check-$PATH">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Commands that are available in login shell are not necessarily available during remote execution. Basically, remote execution through <code>ssh</code> invokes a non-interactive and non-login shell with basic <code>$PATH</code>. SoS tries to address this problem by executing commands through a login shell</p>
<div class="highlight"><pre><span></span>% ssh remote-host <span class="s2">&quot;bash --login -c &#39;sos execute task_id&#39;&quot;</span>
</pre></div>
<p>However, default <code>.bashrc</code> on the remote server might contain a line like</p>
<div class="highlight"><pre><span></span><span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$PS1</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span>
</pre></div>
<p>that makes it exit when <code>bash</code> is not running interactively. This line has to be removed in order to have complete <code>$PATH</code> during remote execution.</p>
<p>Now, fire command</p>
<div class="highlight"><pre><span></span>% ssh remote-host <span class="s2">&quot;bash --login -c &#39;sos -h&#39;&quot;</span>
</pre></div>
<p>from your local machine and see if <code>sos</code> can be invoked. Similarly, verify if the command you would like to execute remotely can be executed in this manner.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Configure-address">Configure <code>address</code><a class="anchor-link" href="#Configure-address">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To make it easier to communicate with the remote server, give it an alias so that you do not have to specify the long URL each time. To do this execute command</p>

<pre><code>% sos config --global --set hosts.monster.address dcdrlue8ee.yourdomain.com</code></pre>
<p>where <code>monster</code> is a short alias and <code>dcdrlue8ee.yourdomain.com</code> is the complete address.</p>
<p>This commands writes to <code>~/.sos/config.yml</code> the following entry</p>

<pre><code>yml
hosts:
  monster:
    address: dcdrlue8ee.yourdomain.com</code></pre>
<p>You can write to this file directly if you are familiar with YML format.</p>
<p>If your account name differs between the local and remote servers, the complete address should be <code>username@address</code>. In this example <code>john@dcdrlue8ee.yourdomain.com</code> if the remote server account is <code>john</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Configure-path_map">Configure <code>path_map</code><a class="anchor-link" href="#Configure-path_map">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>path_map</code> is a list of directory mappings between local and remote directories. For example, if you work locally on a Mac machine with home directory <code>/Users/myuser</code>, and the remote server is a Linux machine with home directory <code>/home/myuser</code>, you should define a <code>path_map</code> using command</p>

<pre><code>% sos config --global --set hosts.monster.path_map /Users/myuser/:/home/myuser/</code></pre>
<p>In this way, if the local data is <code>/User/myuser/projects/input.fastq</code>, the path will be translated to <code>/home/myuser/projects/input.fastq</code> during remote execution.</p>
<p>In more complicated cases where there are different directories, more than one mapping can be specified. For example, if you have directories under different volumes, you can map them differently using</p>
<div class="highlight"><pre><span></span>% sos config --global --set hosts.monster.path_map <span class="se">\</span>
    /Users/myuser/projects/:/home/myuser/scratch/projects/  <span class="se">\</span>
    /Volumes/Resource:/home/myuser/resource <span class="se">\</span>
    /Users/myuser:/home/myuser
</pre></div>
<p>This command will write the following entries to the configuration file</p>

<pre><code>yml
hosts:
  monster:
    address: dcdrlue8ee.yourdomain.com
    path_map:
    - /Users/myuser/projects/:/home/myuser/scratch/projects/
    - /Volumes/Resource:/home/myuser/resource
    - /Users/myuser:/home/myuser</code></pre>
<p>and will map your local direcrories as follows</p>

<pre><code>~/projects/data ==&gt; /home/myuser/scratch/projects/data
/Volumes/Resources/hg19.fasta ==&gt; /home/myuser/resource/hg19.fasta
~/myscript ==&gt; /home/myuser/myscript.py</code></pre>
<p>Note that</p>
<ol>
<li>Both source and destination paths should be absolute (starts with <code>/</code> for Linux-like systems).</li>
<li>SoS expands local directories to absolute path before applying <code>path_map</code>.</li>
<li>SoS applies path maps at the order in which they are specified, so you should specify general mappings after more specific ones. For example, if you specify <code>/Users/myuser:/home/myuser</code> before <code>/Users/myuser/projects/:/home/myuser/scratch/projects/</code>, path <code>/Users/myuser/projects/input.txt</code> would be mapped to <code>/home/myuser/projects/input</code>, not to the intended directory <code>/home/myuser/scratch/projects/input</code>.</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Configure-shared">Configure <code>shared</code><a class="anchor-link" href="#Configure-shared">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Option <code>shared</code> tells SoS which file systems are shared between local and remote hosts so that it does not have to synchronize files under these directories between the hosts.</p>
<ul>
<li><p>SoS assumes independent file systems so you do not have to specify option <code>shared</code> if the local and remote hosts does not share any file system.</p>
</li>
<li><p>If your local and remote host share all file systems, you should use command</p>
<div class="highlight"><pre><span></span>% sos config --global --set hosts.monster.shared /
</pre></div>
<p>to indicate that the root directory is shared so no cross-network copy is needed.</p>
</li>
<li><p>If your local and remote host share one or more shared volumes, you can specify them with command</p>
<div class="highlight"><pre><span></span>% sos config --global --set hosts.monster.shared /projects /data
</pre></div>
<p>to indicate that local files under these directories are available on the remote host.</p>
</li>
</ul>
<p>Shared file systems do not have to be mounted at the same locations. For example, a local file system <code>/projects</code> might be available at the remote host under <code>/scratch/projects</code>. In this case, you should</p>
<ul>
<li>Set <code>/projects</code> as <code>shared</code> so that files under <code>/projects</code> will not be copied.</li>
<li>Set <code>/projects:/scratch/projects</code> in <code>path_map</code> so that the path can be correctly translated between local and remote hosts.</li>
</ul>
<p>It is important to remember that <strong>SoS does not copy files under shared directories</strong>. If the local and remote host share a file system but you really would like to copy files to a differenet directory, you can ignore the <code>shared</code> option and let SoS copy files as if they are separate file systems.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Sample-configurations">Sample configurations<a class="anchor-link" href="#Sample-configurations">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The server settings are critically important for the successful execution of commands on remote servers. As an example, I am working on a Mac mini (with limited CPU/RAM) and have access to a Mac Pro workstation and a Linux server. The hosts configurations for these two machines are</p>

<pre><code>yml
hosts:
  macpro:
    address: mp-bpeng.mdanderson.edu
    path_map:
    - /Users/bpeng1/.sos/RNASeq/:/Volumes/Home/.sos/
  linux:
    address: dcdrlpmcfd.mdanderson.edu
    path_map:
    - /Users/bpeng1/.sos/RNASeq/:/home/bpeng1/.sos/
    - /Users/bpeng1:/home/bpeng1</code></pre>
<p>For the Macpro,</p>
<ol>
<li>Resources under <code>~/.sos/RNASeq</code> is mapped to a separate volume under <code>/Volumes/Home/.sos</code>.</li>
<li>Both systems have <code>/Users/bpeng1</code> so no other mapping is needed.</li>
</ol>
<p>For the linux server,</p>
<ol>
<li>Resources under local <code>~/.sos/RNASeq</code> is mapped to <code>/home/bpeng1/.sos</code> on the server</li>
<li>Home directory <code>/Users/bpeng1</code> is mapped to <code>/home/bpeng1</code> on the linux server.</li>
<li>No file system is shared between the Mac mini and the Linux server.</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Running-tasks-remotely">Running tasks remotely<a class="anchor-link" href="#Running-tasks-remotely">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Option-queue">Option <code>queue</code><a class="anchor-link" href="#Option-queue">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you have set up a host in SoS configuration file propertly, you can use option <code>queue</code> to specify the host on which the task will be executed.</p>

<pre><code>yml
task:   queue='monster'</code></pre>
<p>Here <code>monster</code> is the alias of the host.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Instead of using a configuration file to save configurations to all hosts, you can also specify all host related information in option <code>queue</code> as a dictionary. This method is preferred by users who would like to keep everything in the script. A common usage pattern is to define all hosts in the global section of the script:</p>
<div class="highlight"><pre><span></span><span class="n">host1</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;address&#39;</span><span class="p">:</span> <span class="s1">&#39;address-of-host1&#39;</span>
        <span class="s1">&#39;path_map&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;path1:remote_path1&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;path2:remote_path2&#39;</span><span class="p">],</span>
         <span class="s1">&#39;shared&#39;</span><span class="p">:</span>  <span class="s1">&#39;/shared/path&#39;</span>
         <span class="p">}</span>
<span class="n">host2</span> <span class="o">=</span> <span class="o">...</span>
</pre></div>
<p>and use the configurations as follows:</p>
<div class="highlight"><pre><span></span><span class="kn">task:</span>     <span class="kp">queue</span><span class="o">=</span><span class="n">host1</span><span class="p">,</span>
          <span class="kp">to_host</span><span class="o">=...</span><span class="p">,</span> <span class="kp">from_host</span><span class="o">=...</span>
</pre></div>
<p>Or even allows the specification of hosts from command line:</p>
<div class="highlight"><pre><span></span><span class="n">hosts</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;host1&#39;</span><span class="p">:</span> <span class="o">...</span><span class="p">,</span>
         <span class="s1">&#39;host2&#39;</span><span class="p">:</span> <span class="o">...</span><span class="p">,</span>
         <span class="s1">&#39;localhost&#39;</span><span class="p">:</span> <span class="bp">None</span>
         <span class="p">}</span>
<span class="c1"># by default execute locally        </span>
<span class="kn">parameter:</span> <span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>

<span class="p">[</span><span class="mi">10</span><span class="p">]</span>
<span class="kn">task:</span>   <span class="kp">queue</span><span class="o">=</span><span class="n">hosts</span><span class="p">[</span><span class="n">host</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Command-line-option--q">Command line option <code>-q</code><a class="anchor-link" href="#Command-line-option--q">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Command line option <code>-q</code> specify a default task queue (or remote host) to which all tasks would be submitted. This option does not override <code>queue</code> options defined in the script so you can submit most jobs to a queue while submitting some jobs to particular servers (e.g. the one with specific software) using task options.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Options-to_host-and-from_host">Options <code>to_host</code> and <code>from_host</code><a class="anchor-link" href="#Options-to_host-and-from_host">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that you have your machine configured, you should try to copy some files and see if they work correctly. File copy is specified with options <code>to_host</code> and <code>from_host</code>, which accepts a single file or directory name (string) or list (or nested lists) of filenames. You can test these options using simple SoS steps such as (replace filenames with files you have, of course),</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="kn">task:</span> 
    <span class="kp">queue</span><span class="p">:</span> <span class="s1">&#39;monster&#39;</span><span class="p">,</span>
    <span class="kp">to_host</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;~/projects/data/test1&#39;</span><span class="p">,</span> <span class="s1">&#39;/Volumes/Resources/hg19.fasta&#39;</span><span class="p">],</span>
    <span class="kp">from_host</span><span class="p">:</span> <span class="s1">&#39;~/projects/data/test1.res&#39;</span>
<span class="kn">run:</span>
    <span class="n">echo</span> <span class="s2">&quot;Hello, World&quot;</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>Input, dependent, and output files are automatically transferred</strong> so <code>to_host</code> and <code>from_host</code> are only needed to transfer files or directories in addition to step input and outputs. If there is any problem with file transfer, use option <code>-v3</code> to check if filenames are mapped correctly.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Variable-translation">Variable translation<a class="anchor-link" href="#Variable-translation">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Each task has a <strong>context dictionary</strong> that contains variables that will be used to, for example, compose scripts to be executed. Even if the task will be executed remotely, you should write your task using local paths, and <strong>define variables for all paths that would differ between local and remote hosts</strong>. For example, you might have a script that generates a <code>STAR</code> index from a fasta file. You can have all these files available locally and write the task as:</p>

<pre><code>depends:      hg19_fasta
run:
    STAR \
        --runThreadN 8 \
        --runMode genomeGenerate \
        --genomeDir ${hg19_star_index} \
        --genomeFastaFiles ${hg19_fasta} \
        --sjdbGTFfile ${hg19_genes_gtf} \
        --sjdbOverhang 100</code></pre>
<p>where  <code>hg19_fasta</code>, <code>hg19_genes_gtf</code> and <code>hg19_star_index</code> are variables pointing to input and output files of this process.</p>
<p><strong>SoS will by default translate all variables (of type string and list of strings) as if they are local paths</strong>. In this case, all three variables will be translated to remote paths during remote execution. You can view details of variable translation using option <code>-v3</code> (debug output).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Option-preserved_vars">Option <code>preserved_vars</code><a class="anchor-link" href="#Option-preserved_vars">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Automatic variable translation is convenient but SoS can make mistakes because it does not really know which variable contains path names that need to be converted. For example, if you do not have <code>hg19_fasta</code> locally and use variable <code>hg19_fasta</code> to point to fasta file on the remote host, you can add this variable to option <code>preserved_vars</code> so that its value will not be mapped during context switch:</p>
<div class="highlight"><pre><span></span><span class="kn">task:</span>     <span class="kp">queue</span><span class="o">=</span><span class="s1">&#39;monster&#39;</span><span class="p">,</span> <span class="kp">preserved_vars</span><span class="o">=</span><span class="s1">&#39;hg19_fasta&#39;</span>
<span class="kn">run:</span>
    <span class="n">STAR</span> \
        <span class="o">--</span><span class="n">runThreadN</span> <span class="mi">8</span> \
        <span class="o">--</span><span class="n">runMode</span> <span class="n">genomeGenerate</span> \
        <span class="o">--</span><span class="n">genomeDir</span> <span class="err">$</span><span class="p">{</span><span class="n">hg19_star_index</span><span class="p">}</span> \
        <span class="o">--</span><span class="n">genomeFastaFiles</span> <span class="err">$</span><span class="p">{</span><span class="n">hg19_fasta</span><span class="p">}</span> \
        <span class="o">--</span><span class="n">sjdbGTFfile</span> <span class="err">$</span><span class="p">{</span><span class="n">hg19_genes_gtf</span><span class="p">}</span> \
        <span class="o">--</span><span class="n">sjdbOverhang</span> <span class="mi">100</span>
</pre></div>
<p>Other variables that need to be preserved include sample names, command line options etc.</p>
<p>Note that you can write tasks for remote hosts (e.g. use hard-coded paths or preserve related variables) but that will make your task host-dependent. It is recommended that you <strong>write your script in local paths</strong> and let SoS do the conversion so that you do not have to change the script itself if you would like to execute the task locally or switch to hosts with differnt configurations.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Running-task">Running task<a class="anchor-link" href="#Running-task">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>With all the pieces put together, you can now execute the task on the remote host using <code>task</code> options</p>
<div class="highlight"><pre><span></span><span class="kn">depends:</span>  <span class="n">hg19_fasta</span><span class="p">,</span> <span class="n">hg19_genes_gtf</span>
<span class="kn">output:</span>   <span class="s2">&quot;${hg19_star_index}/chrName.txt&quot;</span>
<span class="kn">task:</span>     <span class="kp">queue</span><span class="o">=</span><span class="s1">&#39;monster&#39;</span><span class="p">,</span> <span class="kp">from_host</span><span class="o">=</span><span class="n">hg19_star_index</span>
<span class="kn">run:</span>
    <span class="n">STAR</span> \
        <span class="o">--</span><span class="n">runThreadN</span> <span class="mi">8</span> \
        <span class="o">--</span><span class="n">runMode</span> <span class="n">genomeGenerate</span> \
        <span class="o">--</span><span class="n">genomeDir</span> <span class="err">$</span><span class="p">{</span><span class="n">hg19_star_index</span><span class="p">}</span> \
        <span class="o">--</span><span class="n">genomeFastaFiles</span> <span class="err">$</span><span class="p">{</span><span class="n">hg19_fasta</span><span class="p">}</span> \
        <span class="o">--</span><span class="n">sjdbGTFfile</span> <span class="err">$</span><span class="p">{</span><span class="n">hg19_genes_gtf</span><span class="p">}</span> \
        <span class="o">--</span><span class="n">sjdbOverhang</span> <span class="mi">100</span>
</pre></div>
<p>For this example,</p>
<ol>
<li>SoS automatically transfers all input (None in this example) and dependent files (<code>hg19_fasta1 and</code>hg19_genes_gtf<code>in this example) so no</code>to_host` is needed.</li>
<li>All variables are path names that can be safely translated by SoS so option <code>preserved_vars</code> is not needed.</li>
<li>Option <code>from_host</code> is needed because we need to transfer not only the reprsenting output file (<code>hg19_star_index}/chrName.txt</code>), but also the whole directory containing the whole indexes (<code>hg19_star_index</code>).</li>
</ol>
<p>SoS tries its best to automate the process while allowing you to tweak the details with runtime options. Just to recap the use of these  options:</p>
<ul>
<li><code>to_host</code> is needed to transfer <strong>additional input</strong> files or directories to remote host.</li>
<li><code>from_host</code> is needed to tranfer <strong>additional output</strong> files or directories from remote host.</li>
<li><code>preserve_vars</code> is needed to prevent some variables from being translated automatically by SoS.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Monitor-the-status-of-the-remote-task">Monitor the status of the remote task<a class="anchor-link" href="#Monitor-the-status-of-the-remote-task">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Tasks executed on remote servers are external in the sense that they could be monitored and killed externally. When you submit the task, you will be given a task ID, using which you can query the status of the task or cancel the tak. For example,</p>

<pre><code>sos status task_id -q shark</code></pre>
<p>can be used to check the status of <code>task_id</code> on a remote server <code>shark</code>, and command</p>

<pre><code>sos kill task_id -q shark</code></pre>
<p>can be used to kill a running task with ID <code>task_id</code>. You can also use command</p>

<pre><code>sos status task_id -q shark -v 3</code></pre>
<p>to display the details of task, including the SoS (Python) statements that will be executed.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Submit-tasks-to-a-task-queue">Submit tasks to a task queue<a class="anchor-link" href="#Submit-tasks-to-a-task-queue">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Instead of executing the task directly on a remote server, you can submit the task to a task queue (e.g. PBS/Torch of a cluster sytem) where the task could be distributed to working nodes of a cluster system. A little more configuration would be needed, basically, you will need to configure</p>
<ul>
<li><code>queue_type</code>: type of the task queue</li>
</ul>
<p>and for <code>queue_type = pbs</code>, configurations such as</p>
<ul>
<li><code>template_file</code>: A template to generate jobs to be submitted,</li>
<li><code>submit_cmd</code>: command to submit PBS jobs,</li>
<li><code>status_cmd</code>: command to check status of jobs, and</li>
<li><code>kill_cmd</code>: command to cancel/delete pending or running jobs.</li>
</ul>
<p>You will also need to specify the resources needed to execute your task, using task options such</p>
<ul>
<li><code>walltime</code>: estimated time</li>
<li><code>mem</code>: estimated memory usage</li>
<li><code>nodes</code>: number of computing nodes</li>
<li><code>ppn</code>: number of process per node</li>
</ul>
<p>With these configurations and options properly set up, you will be able to execute the task using the same syntax, e.g.</p>

<pre><code>sos run myscript -q pbs
sos status -q pbs
sos kill tasks -q pbs</code></pre>
<p>where <code>pbs</code> is the alias of the cluster system.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="An-example-using-docker">An example using docker<a class="anchor-link" href="#An-example-using-docker">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Here is real-world example of running a bioinformatics tool (<code>tophat2</code>) on a remote server using docker. The remote server is a Linux server with docker installed. The local machine has all the reference data and annotation files (<code>hg19_fasta</code>, <code>hg19_genes_gtf</code>), and the Bowtie2 index (<code>hg19_Bowtie2_index</code>) but do not have tophat installed (lacking a Python 2 environment).</p>
<p>The following step runs tophat2 on the input fastq files using a remote host (with alias <code>linux</code>) and docker image <code>genomicpariscentre/tophat2</code>.</p>
<div class="highlight"><pre><span></span><span class="p">[</span><span class="n">tophat</span><span class="o">-</span><span class="n">align</span><span class="p">]</span>
<span class="c1"># align reads using the TOPHAT aligner</span>
<span class="kn">depends:</span>  <span class="n">hg19_genes_gtf</span><span class="p">,</span> <span class="n">hg19_fasta</span><span class="p">,</span> <span class="s2">&quot;${hg19_Bowtie2_index}/genome.1.bt2&quot;</span>
<span class="kn">input:</span>    <span class="n">fastq_files</span>
<span class="kn">output:</span>   <span class="s2">&quot;${output_dir}/tophat_main/alignments.bam&quot;</span>

<span class="kn">task:</span>   <span class="kp">queue</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="kp">to_host</span><span class="o">=</span><span class="n">hg19_Bowtie2_index</span><span class="p">,</span>
        <span class="kp">from_host</span><span class="o">=</span><span class="s2">&quot;${output_dir}/tophat_main&quot;</span><span class="p">,</span> <span class="kp">preserved_vars</span><span class="o">=</span><span class="s1">&#39;sample_name&#39;</span>

<span class="n">R1</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">input</span> <span class="k">if</span> <span class="s1">&#39;_R1_&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>
<span class="n">R2</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">input</span> <span class="k">if</span> <span class="s1">&#39;_R2_&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>
<span class="kp">stop_if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">R1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">R2</span><span class="p">),</span> <span class="s2">&quot;Unequal number of R1 and R2 files from input ${fastq_files}&quot;</span><span class="p">)</span>

<span class="c1"># genomicpariscentre only has tophat2 (bowtie2) so it does not support option --bortie1</span>
<span class="kn">run:</span>    <span class="n">docker_image</span><span class="o">=</span><span class="s1">&#39;genomicpariscentre/tophat2&#39;</span>

    <span class="p">[</span> <span class="o">-</span><span class="n">d</span> <span class="err">$</span><span class="p">{</span><span class="n">output_dir</span><span class="p">}</span> <span class="p">]</span> <span class="o">||</span> <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="err">$</span><span class="p">{</span><span class="n">output_dir</span><span class="p">}</span>
    <span class="n">tophat2</span>  \
        <span class="o">--</span><span class="n">read</span><span class="o">-</span><span class="n">realign</span><span class="o">-</span><span class="n">edit</span><span class="o">-</span><span class="n">dist</span> <span class="mi">1</span> \
        <span class="o">--</span><span class="n">segment</span><span class="o">-</span><span class="n">length</span> <span class="mi">24</span> \
        <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;${output_dir}/tophat_main&#39;</span> \
        <span class="o">-</span><span class="n">p</span> <span class="mi">7</span> \
        <span class="o">--</span><span class="n">GTF</span> <span class="s1">&#39;${hg19_genes_gtf}&#39;</span> \
        <span class="o">--</span><span class="n">rg</span><span class="o">-</span><span class="nb">id</span> <span class="mi">0</span> \
        <span class="o">--</span><span class="n">rg</span><span class="o">-</span><span class="n">sample</span> <span class="s1">&#39;${sample_name}&#39;</span> \
        <span class="o">--</span><span class="n">library</span><span class="o">-</span><span class="nb">type</span> <span class="n">fr</span><span class="o">-</span><span class="n">firststrand</span> \
        <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">coverage</span><span class="o">-</span><span class="n">search</span> \
        <span class="o">--</span><span class="n">keep</span><span class="o">-</span><span class="n">fasta</span><span class="o">-</span><span class="n">order</span>  \
        <span class="o">--</span><span class="n">fusion</span><span class="o">-</span><span class="n">search</span> <span class="o">--</span><span class="n">fusion</span><span class="o">-</span><span class="n">anchor</span><span class="o">-</span><span class="n">length</span> <span class="mi">13</span> \
        <span class="o">--</span><span class="n">fusion</span><span class="o">-</span><span class="n">ignore</span><span class="o">-</span><span class="n">chromosomes</span> <span class="n">chrM</span><span class="p">,</span><span class="n">M</span> <span class="s1">&#39;${hg19_Bowtie2_index}/genome&#39;</span> \
        <span class="s1">&#39;${R1!ae,}&#39;</span> <span class="s1">&#39;${R2!ae,}&#39;</span>
</pre></div>
<p>When the step is executed, SoS will</p>
<ol>
<li>Transfer <code>hg19_genes_gtf</code>, <code>hg19_fasta</code>, <code>${hg19_Bowtie2_index}/genome.1.bt2</code> (specified by <code>depends</code>), <code>fastq_files</code> (specified by <code>input</code>) and <code>hg19_Bowtie2_index</code> (specified by <code>to_host</code>) to remote server.</li>
<li>Translate all variables (<code>input</code>, <code>output</code>, <code>hg19_genes_gtf</code> etc) except for <code>sample_name</code> (specified by option <code>preserved_vars</code>).</li>
<li>On server <code>linux</code>, before starting the script, download docker image <code>genomicpariscentre/tophat2</code> if not already available.</li>
<li>Start the bash script in the docker container.</li>
</ol>
<p>With this setup, everything is provided and specified by the local host. The server does not have to have any data and software installed so you are free to make use of any server with docker installed.</p>

</div>
</div>
</div>
    </div>
  </div>
</body>

 


</html>
