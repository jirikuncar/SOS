<!DOCTYPE html>
<html>
<head><meta charset="utf-8" />
<title>Remote_Execution</title><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>








<!-- Custom stylesheet, it must be in the same directory as the html file -->
<link rel="stylesheet" href="custom.css">

<!-- Loading mathjax macro -->
<!-- Load mathjax -->
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
    <!-- MathJax configuration -->
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
            processEscapes: true,
            processEnvironments: true
        },
        // Center justify equations in code and markdown cells. Elsewhere
        // we use CSS to left justify single line equations in code cells.
        displayAlign: 'center',
        "HTML-CSS": {
            styles: {'.MathJax_Display': {"margin": 0}},
            linebreaks: { automatic: true }
        }
    });
    </script>
    <!-- End of mathjax configuration --></head>

 <link rel="stylesheet" href="http://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/jquery-ui.min.js"></script>

<style>  /* defined here in case the main.css below cannot be loaded */
.lev1 {margin-left: 80px}
.lev2 {margin-left: 100px}
.lev3 {margin-left: 120px}
.lev4 {margin-left: 140px}
.lev5 {margin-left: 160px}
.lev6 {margin-left: 180px}
</style>

<link rel="stylesheet" type="text/css" href="../../css/jt.css">
<link rel="stylesheet" type="text/css" href="../../css/toc2.css">

<script src="https://rawgit.com/ipython-contrib/jupyter_contrib_nbextensions/master/src/jupyter_contrib_nbextensions/nbextensions/toc2/toc2.js"></script>

 <script src="../../js/docs.js"></script>

<script>
    MathJax.Hub.Config({
        "HTML-CSS": {
            preferredFont: "TeX",
            availableFonts: ["STIX","TeX"],
            styles: {
                scale: 110,
                ".MathJax_Display": {
                    "font-size": "110%",
                }
            }
        }
    });
</script>

<script>
$( document ).ready(function(){

            var cfg={'threshold':3,     // depth of toc (number of levels)
             // 'number_sections': false,  
             'number_sections': false,  // sections numbering
             'toc_cell': false,          // useless here
             'toc_window_display': true, // display the toc window
             "toc_section_display": "block", // display toc contents in the window
             // 'sideBar':false,      
             'sideBar':true,       // sidebar or floating window
             'navigate_menu':false       // navigation menu (only in liveNotebook -- do not change)
            }

            var st={};                  // some variables used in the script
            st.rendering_toc_cell = false;
            st.config_loaded = false;
            st.extension_initialized=false;
            st.nbcontainer_marginleft = $('#notebook-container').css('margin-left')
            st.nbcontainer_marginright = $('#notebook-container').css('margin-right')
            st.nbcontainer_width = $('#notebook-container').css('width')
            st.oldTocHeight = undefined
            st.cell_toc = undefined;
            st.toc_index=0;

            // fire the main function with these parameters


            table_of_contents(cfg,st);


            var file=tutorialsDict[$("h1:first").attr("id")];
            var path="http://vatlab.github.io/SOS"
            // var path="file:///Users/jma7/Development/SOS/docs"
            $("#toc-level0 a").css("color","#126dce");
            $('a[href="#'+$("h1:first").attr("id")+'"]').hide()
            
            var tuts=tutorials;
            var pos=tutorials.indexOf(file);
        
            for (var a=pos;a>=0;a--){
                  var name=tuts[a]
                  $('<li><a href="'+path+'/doc/tutorials/'+name+'.html">'+name.replace(/_/g," ")+'</a></li>').insertBefore("#toc-level0 li:eq(0)");
            }
            $('a[href="'+path+'/doc/tutorials/'+file+'.html'+'"]').css("color","#126dce");

            $('<li id="indexHome" style="margin-bottom:10pt"> <a href="http://vatlab.github.io/SOS/index.html#documentation"> <img height="32" width="32" style="border:0px;margin-right:5px;vertical-align:bottom" src="http://vatlab.github.io/SOS/img/sos_icon.svg"> <b>Home</b></a> </li>').insertBefore("#toc-level0 li:eq(0)");
            for (var a=pos+1;a<tuts.length;a++){
                  var name=tuts[a]
                  $(".toc #toc-level0").append('<li><a href="'+path+'/doc/tutorials/'+name+'.html">'+name.replace(/_/g," ")+'</a></li>');
            }
            $("#toc-header").hide();
            $("#toc").attr("style","max-height:938px")


            // for (var a =0;a<tuts.length;a++){
            //       var name =tuts[a];
            //       if ()
            //       $(".toc #toc-level0").append('<li><a href="'+path+'/doc/tutorials/'+name+'.html">'+name.replace("_"," ")+'</a></li>');
            // }

            // $(".toc #toc-level0").append('<li id="indexHome"><a href="'+path+'/index.html"><b>Home<b></a></li>');
            // var home=$("#toc-level0 #indexHome");
          
            // home.insertBefore("#toc-level0 li:eq(0)");

            
            // $(".number_sections-btn").hide();
            // $(".toc_cell_sections-btn".hide();


    });
</script><style>  /* defined here in case the main.css below cannot be loaded */

 .lan_sos {}.lan_python2 {background-color: #F6FAEA !important }.lan_python3 {background-color: #EAFAF1 !important }.lan_ir {background-color: #FDEDEC !important }.lan_bash {background-color: #E6EEFF !important }

</style>
<body>
  <div tabindex="-1" id="notebook" class="border-box-sizing">
    <div class="container" id="notebook-container">

<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Execution-of-tasks-on-remote-host-without-shared-file-system">Execution of tasks on remote host without shared file system<a class="anchor-link" href="#Execution-of-tasks-on-remote-host-without-shared-file-system">&#182;</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>SoS allow you to execute tasks on remote hosts with their own file system. For example, you can execute a complex workflow mostly locally, but execute jobs on remote servers if they have more computing power, or if they have some software that cannot be installed locally.</p>
<p>With help from a few runtime options (options to <code>task</code>), SoS can</p>
<ul>
<li>Copy specified local files to the remote host, possibly to different directories</li>
<li>Start a SoS task on the remote machine and wait for the completion of the task</li>
<li>Copy results back from the remote host if the execution is successful</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="System-setup">System setup<a class="anchor-link" href="#System-setup">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Set-up-public-key-access-to-the-remote-host">Set up public-key access to the remote host<a class="anchor-link" href="#Set-up-public-key-access-to-the-remote-host">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Following any online tutorial, set up public-key access from your local machine to the remote host. If your public key does not work, check file permissions of <code>.ssh</code>, keys under <code>.ssh</code>, and <code>$HOME</code> in some cases. After setting up the server, make sure you can login without password using command</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

<pre><code>% ssh remote-host</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Install-SoS-and-required-software">Install SoS and required software<a class="anchor-link" href="#Install-SoS-and-required-software">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You will need to install the latest version of sos (preferrably identical version between local and remote hosts), and the software you will need to run. Test it by logging to the remote machine with commands</p>

<pre><code>% sos -h</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Make-sure-$PATH-works-in-non-login-mode">Make sure <code>$PATH</code> works in non-login mode<a class="anchor-link" href="#Make-sure-$PATH-works-in-non-login-mode">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Commands that are available in login shell are not necessarily available during remote execution. Basically, remote execution through <code>ssh</code> invokes a non-interactive and non-login shell with basic <code>$PATH</code>. SoS tries to address this problem by executing commands through a login shell</p>

<pre><code>% ssh remote-host "bash --login -c 'sos-command-to-run'"</code></pre>
<p>but your <code>.bashrc</code> might contain a line like</p>

<pre><code>[ -z "$PS1" ] &amp;&amp; return</code></pre>
<p>that makes it exit prematurally. Remove this line if this is the case.</p>
<p>Now, fire command</p>

<pre><code>% ssh remote-host "bash --login -c 'sos -h'"</code></pre>
<p>from your local machine and see if <code>sos</code> can be invoked. Similarly, check if the command you would like to execute remotely can be executed in this way.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Set-up-a-local-configuration-file">Set up a local configuration file<a class="anchor-link" href="#Set-up-a-local-configuration-file">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This step is optional but is highly recommended. Basically you can save necessary information for each remote host that you would like to use in SoS configuration file so that you do not have to specify them one by one.</p>
<p>First, give your host an alias so that you do not have to specify the long URL each time. To do this execute command</p>

<pre><code>% sos config --global --set hosts.monster.address dcdrlue8ee.yourdomain.com</code></pre>
<p>where <code>monster</code> is a short alias and <code>dcdrlue8ee.yourdomain.com</code> is the complete address.</p>
<p>This commands writes to <code>~/.sos/config.yml</code> the following entry</p>

<pre><code>$ cat ~/.sos/config.yml
hosts:
  monster:
    address: dcdrlue8ee.yourdomain.com</code></pre>
<p>You can write to this file directly if you are familiar with YML format.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Set-up-path_map">Set up <code>path_map</code><a class="anchor-link" href="#Set-up-path_map">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>path_map</code> is a list of directory mappings between local and remote directories. For example, if you work locally on a Mac machine with home directory <code>/Users/myuser</code>, and the remote server is a Linux machine with home directory <code>/home/myuser</code>, you should define a <code>path_map</code> using command</p>

<pre><code>% sos config --global --set hosts.monster.path_map /Users/myuser/:/home/myuser/</code></pre>
<p>In this way, if the local data is <code>/User/myuser/projects/input.fastq</code>, the path will be translated to <code>/home/myuser/projects/input.fastq</code> during remote execution.</p>
<p>In more complicated cases where there are different directories, more than one mapping can be specified. For example, if you have directories under different volumes, you can map them differently using</p>

<pre><code>% sos config --global --set hosts.monster.path_map \
    /Users/myuser/projects/:/home/myuser/scratch/projects/  \
    /Volumes/Resource:/home/myuser/resource \
    /Users/myuser:/home/myuser</code></pre>
<p>This command will result in</p>

<pre><code>$ cat ~/.sos/config.yml
hosts:
  monster:
    address: dcdrlue8ee.yourdomain.com
    path_map:
    - /Users/myuser/projects/:/home/myuser/scratch/projects/
    - /Volumes/Resource:/home/myuser/resource
    - /Users/myuser:/home/myuser</code></pre>
<p>and will map your local direcrories as follows</p>

<pre><code>~/projects/data ==&gt; /home/myuser/scratch/projects/data
/Volumes/Resources/hg19.fasta ==&gt; /home/myuser/resource/hg19.fasta
~/myscript ==&gt; /home/myuser/myscript.py</code></pre>
<p>Note that</p>
<ol>
<li>SoS expands local directories to absolute path before applying <code>path_map</code>.</li>
<li>SoS applies path maps at the other in which they are specified, so you should specify general mappings after more specific ones. </li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Copying-files-back-and-forth-(task-options-to_host-and-from_host)">Copying files back and forth (<code>task</code> options <code>to_host</code> and <code>from_host</code>)<a class="anchor-link" href="#Copying-files-back-and-forth-(task-options-to_host-and-from_host)">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that you have your machine configured, you should try to copy some files and see if they work correctly. File copy is specified with options <code>to_host</code> and <code>from_host</code>. You can test these options using simple SoS steps such as (replace filenames with files you have, of course),</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

<pre><code>[1]
task: 
    on_host: 'monster',
    to_host: ['~/projects/data/test1', '/Volumes/Resources/hg19.fasta'],
    from_host: '~/projects/data/test1.res'
run:
    echo "Hello, World"</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Note that:</p>
<ol>
<li>Option <code>on_host</code> specifies the host to connect, and allows SoS to retrieve <code>path_map</code> from configuration file.</li>
<li>Option <code>to_host</code> specifies local files or directories that will be copied to the remote host (using <code>rsync</code>).</li>
<li>Options <code>from_host</code> specifies <strong>local files</strong> that will be copied from the remote host. SoS will figure out the corresponding remote file to be copied.</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Translate-your-task-to-be-executed-on-remote-host-(task-option-map_vars)">Translate your task to be executed on remote host (<code>task</code> option <code>map_vars</code>)<a class="anchor-link" href="#Translate-your-task-to-be-executed-on-remote-host-(task-option-map_vars)">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Each task has an <code>environment</code> that contains variables that will be used to, for example, compose scripts to be executed. Even if the task will be executed remotely, you should write your task as if it is executed locally. For example, you might have a script that generates a <code>STAR</code> index from fasta file. You should have all these files available locally and write the task as:</p>

<pre><code>depends:      hg19_fasta
run:
    STAR \
        --runThreadN 8 \
        --runMode genomeGenerate \
        --genomeDir ${hg19_star_index} \
        --genomeFastaFiles ${hg19_fasta} \
        --sjdbGTFfile ${hg19_genes_gtf} \
        --sjdbOverhang 100</code></pre>
<p>Now, to make the script execute remotely, you should tell SoS which variables need to be translated to remote path. This can be done using option <code>map_vars</code></p>

<pre><code>depends:      hg19_fasta

task:     on_host='monster', map_vars=['hg19_fasta', 'hg19_star_index', 'hg19_genes_gtf']
run:
    STAR \
        --runThreadN 8 \
        --runMode genomeGenerate \
        --genomeDir ${hg19_star_index} \
        --genomeFastaFiles ${hg19_fasta} \
        --sjdbGTFfile ${hg19_genes_gtf} \
        --sjdbOverhang 100</code></pre>
<p>This option will <strong>change the runtime environment</strong> of the task so that the script can be composed using variables corresponding to remote servers.</p>
<p>Note that</p>
<ol>
<li>Variables such as <code>_input</code>, <code>input</code>, <code>_output</code> are automatically translated so you only need to specify non-system variables.</li>
<li>You can hard-code path in remote host, but that will make your script host-dependent. It is therefore highly recommended that you <strong>write your script in local paths</strong> and let SoS do the conversion so that you do not have to change the script itself if you are switching to another host with differnt <code>path_map</code>.</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Running-task-remotely">Running task remotely<a class="anchor-link" href="#Running-task-remotely">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>With all the pieces putting together, you can now execute the task on the remote host using <code>task</code> options</p>
<div class="highlight"><pre><span></span><span class="kn">depends:</span>      <span class="n">hg19_fasta</span>

<span class="kn">task:</span>     <span class="kp">on_host</span><span class="o">=</span><span class="s1">&#39;monster&#39;</span><span class="p">,</span> <span class="kp">map_vars</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;hg19_fasta&#39;</span><span class="p">,</span> <span class="s1">&#39;hg19_star_index&#39;</span><span class="p">,</span> <span class="s1">&#39;hg19_genes_gtf&#39;</span><span class="p">],</span>
          <span class="kp">to_host</span><span class="o">=</span><span class="p">[</span><span class="n">hg19_fasta</span><span class="p">,</span> <span class="n">hg19_genes_gtf</span><span class="p">],</span> <span class="kp">from_host</span><span class="o">=</span><span class="n">hg10_index</span>

<span class="kn">run:</span>
    <span class="n">STAR</span> \
        <span class="o">--</span><span class="n">runThreadN</span> <span class="mi">8</span> \
        <span class="o">--</span><span class="n">runMode</span> <span class="n">genomeGenerate</span> \
        <span class="o">--</span><span class="n">genomeDir</span> <span class="err">$</span><span class="p">{</span><span class="n">hg19_star_index</span><span class="p">}</span> \
        <span class="o">--</span><span class="n">genomeFastaFiles</span> <span class="err">$</span><span class="p">{</span><span class="n">hg19_fasta</span><span class="p">}</span> \
        <span class="o">--</span><span class="n">sjdbGTFfile</span> <span class="err">$</span><span class="p">{</span><span class="n">hg19_genes_gtf</span><span class="p">}</span> \
        <span class="o">--</span><span class="n">sjdbOverhang</span> <span class="mi">100</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Advanced-usages">Advanced usages<a class="anchor-link" href="#Advanced-usages">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="path_map-option"><code>path_map</code> option<a class="anchor-link" href="#path_map-option">&#182;</a></h3><p>You can specify <code>path_map</code> as a <code>task</code> option. This allows you to write everything in the script clearly and you do not have to use any configuration file. For example,</p>

<pre><code>task:     on_host='dcdrlue8ee.yourdomain.com', path_map='/Users/myuser:/home/myuser',
          other_options...</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="send_cmd,-received_cmd,-execute_cmd"><code>send_cmd</code>, <code>received_cmd</code>, <code>execute_cmd</code><a class="anchor-link" href="#send_cmd,-received_cmd,-execute_cmd">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>SoS uses <code>rsync</code> command to exchange files between hosts, and use <code>ssh</code> to execute command. If the default commands do not work for your configuration (e.g. if you do not have <code>rsync</code> and need to use <code>scp</code>, you can</p>
<ol>
<li><p>Use option <code>-v3</code> to display the exact command used to transfer files and execute commands</p>
</li>
<li><p>Define options <code>send_cmd</code>, <code>received_cmd</code> and <code>execute_cmd</code> for your particular configuration. These variables should be defined with <code>${source}</code> and <code>${dest}</code> which will be replaced by source and destination filenames for each file.</p>
</li>
</ol>

</div>
</div>
</div>
    </div>
  </div>
</body>

 


</html>
